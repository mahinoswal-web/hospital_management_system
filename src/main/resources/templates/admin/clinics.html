<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Management - Hospital Admin</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.0/css/dataTables.bootstrap5.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/admin-style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-gradient-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/admin">
                <i class="fas fa-hospital"></i> Hospital Admin Panel
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/patients">
                            <i class="fas fa-users"></i> Patients
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/doctors">
                            <i class="fas fa-stethoscope"></i> Doctors
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/clinics">
                            <i class="fas fa-building"></i> Clinics
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> Admin
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/admin/profile">Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/admin">
                                <i class="fas fa-chart-line"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/patients">
                                <i class="fas fa-users"></i> Patients
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/doctors">
                                <i class="fas fa-stethoscope"></i> Doctors
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/admin/clinics">
                                <i class="fas fa-building"></i> Clinics
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/medicines">
                                <i class="fas fa-pills"></i> Medicines
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/tests">
                                <i class="fas fa-flask"></i> Tests
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10 ms-sm-auto px-md-4 py-4">
                <!-- Page Title -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h2 fw-bold text-primary">Clinic Management</h1>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clinicModal">
                        <i class="fas fa-plus-circle"></i> Add New Clinic
                    </button>
                </div>

                <!-- Alert Messages -->
                <div id="alertContainer"></div>

                <!-- Filters -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light border-bottom">
                        <h5 class="mb-0"><i class="fas fa-filter"></i> Search & Filter</h5>
                    </div>
                    <div class="card-body">
                        <form id="filterForm" class="row g-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="filterClinicName" placeholder="Clinic Name">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="filterStatus">
                                    <option value="">Select Status</option>
                                    <option value="ACTIVE">Active</option>
                                    <option value="CLOSED">Closed</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="filterCity" placeholder="City">
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Table -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light border-bottom">
                        <h5 class="mb-0"><i class="fas fa-list"></i> All Clinics</h5>
                    </div>
                    <div class="table-responsive">
                        <table id="clinicsTable" class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Clinic ID</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>City</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clinicTableBody">
                                <tr class="text-center">
                                    <td colspan="7" class="py-4 text-muted">Loading clinics...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Clinic Modal -->
    <div class="modal fade" id="clinicModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light border-bottom">
                    <h5 class="modal-title" id="clinicModalTitle">
                        <i class="fas fa-plus-circle"></i> Add New Clinic
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="clinicForm">
                        <input type="hidden" id="clinicId">

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="clinicIdInput" class="form-label">Clinic ID</label>
                                <input type="text" class="form-control" id="clinicIdInput" required 
                                    placeholder="e.g., CLN-001">
                            </div>
                            <div class="col-md-6">
                                <label for="clinicName" class="form-label">Clinic Name</label>
                                <input type="text" class="form-control" id="clinicName" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="clinicType" class="form-label">Clinic Type</label>
                                <select class="form-select" id="clinicType" required>
                                    <option value="">Select Type</option>
                                    <option value="OPD">OPD</option>
                                    <option value="HOSPITAL">Hospital</option>
                                    <option value="CLINIC">Clinic</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="registrationNumber" class="form-label">Registration Number</label>
                                <input type="text" class="form-control" id="registrationNumber" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" required>
                                    <option value="">Select Status</option>
                                    <option value="ACTIVE">Active</option>
                                    <option value="CLOSED">Closed</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="phone" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                        </div>

                        <h6 class="fw-bold mb-3"><i class="fas fa-map-marker-alt"></i> Address</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" required>
                            </div>
                            <div class="col-md-6">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="pincode" class="form-label">Pincode</label>
                                <input type="number" class="form-control" id="pincode" required>
                            </div>
                            <div class="col-md-6">
                                <label for="country" class="form-label">Country</label>
                                <input type="text" class="form-control" id="country" required>
                            </div>
                        </div>

                        <h6 class="fw-bold mb-3"><i class="fas fa-clock"></i> Timings</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="openingTime" class="form-label">Opening Time</label>
                                <input type="text" class="form-control" id="openingTime" placeholder="09:00 AM">
                            </div>
                            <div class="col-md-6">
                                <label for="closingTime" class="form-label">Closing Time</label>
                                <input type="text" class="form-control" id="closingTime" placeholder="06:00 PM">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="appointmentRequired">
                                    <label class="form-check-label" for="appointmentRequired">
                                        Appointment Required
                                    </label>
                                </div>
                            </div>
                        </div>

                        <h6 class="fw-bold mb-3"><i class="fas fa-stethoscope"></i> Services & Departments</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="departments" class="form-label">Departments</label>
                                <input type="text" class="form-control" id="departments" 
                                    placeholder="e.g., General, Ortho, Dental (comma separated)">
                            </div>
                            <div class="col-md-6">
                                <label for="services" class="form-label">Services</label>
                                <input type="text" class="form-control" id="services" 
                                    placeholder="e.g., OPD, Lab, Pharmacy (comma separated)">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveClinic()">
                        <i class="fas fa-save"></i> Save Clinic
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.0/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.0/js/dataTables.bootstrap5.min.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        let dataTable;
        const clinicModal = new bootstrap.Modal(document.getElementById('clinicModal'));

        // Initialize DataTable
        function initializeTable() {
            if (dataTable) {
                dataTable.destroy();
            }
            dataTable = $('#clinicsTable').DataTable({
                paging: true,
                searching: false,
                ordering: true,
                info: true,
                pageLength: 10,
                destroy: true,
                columnDefs: [
                    { orderable: false, targets: 6 }
                ]
            });
        }

        // Load clinics
        async function loadClinics(filters = {}) {
            try {
                const response = await axios.get('/api/clinics');
                let clinics = response.data;

                // Apply filters
                if (filters.clinicName) {
                    clinics = clinics.filter(c => 
                        c.clinicName?.toLowerCase().includes(filters.clinicName.toLowerCase())
                    );
                }
                if (filters.status) {
                    clinics = clinics.filter(c => c.status === filters.status);
                }
                if (filters.city) {
                    clinics = clinics.filter(c => 
                        c.address?.city?.toLowerCase().includes(filters.city.toLowerCase())
                    );
                }

                $('#clinicsTable tbody').empty();

                if (clinics.length === 0) {
                    $('#clinicsTable tbody').html(
                        '<tr class="text-center"><td colspan="7" class="py-4 text-muted">No clinics found</td></tr>'
                    );
                    if (dataTable) {
                        dataTable.destroy();
                        dataTable = null;
                    }
                } else {
                    clinics.forEach(clinic => {
                        const statusBadge = clinic.status === 'ACTIVE' ? 'bg-success' : 'bg-danger';
                        const row = `
                            <tr>
                                <td><strong>${clinic.clinicId || 'N/A'}</strong></td>
                                <td>${clinic.clinicName || 'N/A'}</td>
                                <td>${clinic.clinicType || 'N/A'}</td>
                                <td>${clinic.address?.city || 'N/A'}</td>
                                <td>${clinic.contact?.phone || 'N/A'}</td>
                                <td>
                                    <span class="badge ${statusBadge}">${clinic.status}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editClinic('${clinic.clinicId}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteClinic('${clinic.clinicId}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                        $('#clinicsTable tbody').append(row);
                    });
                    initializeTable();
                }
            } catch (error) {
                console.error('Error loading clinics:', error);
                showAlert('Error loading clinics', 'danger');
            }
        }

        // Save clinic
        async function saveClinic() {
            const clinicId = document.getElementById('clinicId').value;
            const formData = {
                clinicId: document.getElementById('clinicIdInput').value,
                clinicName: document.getElementById('clinicName').value,
                clinicType: document.getElementById('clinicType').value,
                registrationNumber: document.getElementById('registrationNumber').value,
                status: document.getElementById('status').value,
                openingTime: document.getElementById('openingTime').value,
                closingTime: document.getElementById('closingTime').value,
                appointmentRequired: document.getElementById('appointmentRequired').checked,
                departments: document.getElementById('departments').value ? 
                    document.getElementById('departments').value.split(',').map(s => s.trim()) : [],
                services: document.getElementById('services').value ? 
                    document.getElementById('services').value.split(',').map(s => s.trim()) : [],
                address: {
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    pincode: parseInt(document.getElementById('pincode').value) || 0,
                    country: document.getElementById('country').value
                },
                contact: {
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value
                },
                audit: {
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    createdBy: 'admin'
                }
            };

            try {
                if (clinicId) {
                    await axios.put(`/api/clinics/${clinicId}`, formData);
                    showAlert('Clinic updated successfully', 'success');
                } else {
                    await axios.post('/api/clinics', formData);
                    showAlert('Clinic added successfully', 'success');
                }
                clinicModal.hide();
                resetForm();
                loadClinics();
            } catch (error) {
                console.error('Error saving clinic:', error);
                showAlert('Error saving clinic: ' + (error.response?.data?.message || error.message), 'danger');
            }
        }

        // Edit clinic
        async function editClinic(id) {
            try {
                const response = await axios.get(`/api/clinics/${id}`);
                const clinic = response.data;

                document.getElementById('clinicId').value = id;
                document.getElementById('clinicIdInput').value = clinic.clinicId || '';
                document.getElementById('clinicName').value = clinic.clinicName || '';
                document.getElementById('clinicType').value = clinic.clinicType || '';
                document.getElementById('registrationNumber').value = clinic.registrationNumber || '';
                document.getElementById('status').value = clinic.status || '';
                document.getElementById('openingTime').value = clinic.openingTime || '';
                document.getElementById('closingTime').value = clinic.closingTime || '';
                document.getElementById('appointmentRequired').checked = clinic.appointmentRequired || false;
                
                if (clinic.address) {
                    document.getElementById('city').value = clinic.address.city || '';
                    document.getElementById('state').value = clinic.address.state || '';
                    document.getElementById('pincode').value = clinic.address.pincode || '';
                    document.getElementById('country').value = clinic.address.country || '';
                }
                
                if (clinic.contact) {
                    document.getElementById('phone').value = clinic.contact.phone || '';
                    document.getElementById('email').value = clinic.contact.email || '';
                }
                
                document.getElementById('departments').value = clinic.departments?.join(', ') || '';
                document.getElementById('services').value = clinic.services?.join(', ') || '';

                document.getElementById('clinicModalTitle').innerHTML = 
                    '<i class="fas fa-edit"></i> Edit Clinic';

                clinicModal.show();
            } catch (error) {
                console.error('Error loading clinic:', error);
                showAlert('Error loading clinic details', 'danger');
            }
        }

        // Delete clinic
        async function deleteClinic(id) {
            if (!confirm('Are you sure you want to delete this clinic?')) return;

            try {
                await axios.delete(`/api/clinics/${id}`);
                showAlert('Clinic deleted successfully', 'success');
                loadClinics();
            } catch (error) {
                console.error('Error deleting clinic:', error);
                showAlert('Error deleting clinic', 'danger');
            }
        }

        // Filter clinics
        function applyFilters() {
            const filters = {
                clinicName: document.getElementById('filterClinicName').value,
                status: document.getElementById('filterStatus').value,
                city: document.getElementById('filterCity').value
            };
            loadClinics(filters);
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('filterClinicName').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterCity').value = '';
            loadClinics();
        }

        // Reset form
        function resetForm() {
            document.getElementById('clinicForm').reset();
            document.getElementById('clinicId').value = '';
            document.getElementById('clinicModalTitle').innerHTML = 
                '<i class="fas fa-plus-circle"></i> Add New Clinic';
        }

        // Show alert
        function showAlert(message, type) {
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').insertAdjacentHTML('beforeend', alertHTML);
            setTimeout(() => {
                document.querySelector('.alert')?.remove();
            }, 5000);
        }

        // Event listeners
        document.getElementById('clinicModal').addEventListener('hidden.bs.modal', resetForm);
        document.getElementById('filterClinicName').addEventListener('input', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterCity').addEventListener('input', applyFilters);

        // Load clinics on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadClinics();
        });
    </script>
</body>
</html>
