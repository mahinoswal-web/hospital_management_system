<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{admin/base :: layout(~{::pageContent}, ~{::customStyle}, ~{::customScript})}">
<head>
    <th:block th:fragment="customStyle"></th:block>
</head>
<body>
    <th:block th:fragment="pageContent">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 fw-bold text-primary" id="pageHeader">Add New Test</h1>
            <a href="/admin/tests" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-bottom">
                <h5 class="mb-0"><i class="fas fa-file-medical"></i> Test Details</h5>
            </div>
            <div class="card-body p-4">
                <form id="testForm">
                    <input type="hidden" id="id" th:value="${testId}">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Test Name</label>
                            <input type="text" class="form-control" id="testName" required placeholder="e.g. CBC Blood Test">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Category</label>
                            <input type="text" class="form-control" id="category" required placeholder="e.g. Hematology">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Patient ID</label>
                            <input type="text" class="form-control" id="patientId" required placeholder="PAT-...">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Doctor ID</label>
                            <input type="text" class="form-control" id="doctorId" required placeholder="DOC-...">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="price" required min="0" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Result Status</label>
                            <select class="form-select" id="resultStatus" required>
                                <option value="Pending">Pending</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label fw-bold">Description</label>
                            <textarea class="form-control" id="description" rows="3" placeholder="Details about the test..."></textarea>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label fw-bold">History / Notes</label>
                            <textarea class="form-control" id="history" rows="2" placeholder="Previous history..."></textarea>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="/admin/tests" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="fas fa-save"></i> Save Test
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </th:block>

    <th:block th:fragment="customScript">
        <script>
            const API_URL = '/api/medical_tests';

            document.addEventListener('DOMContentLoaded', () => {
                const testId = document.getElementById('id').value;
                
                // If ID exists, we are in Edit Mode
                if (testId) {
                    document.getElementById('pageHeader').innerText = 'Edit Test';
                    loadTestDetails(testId);
                }

                document.getElementById('testForm').addEventListener('submit', handleFormSubmit);
            });

            async function loadTestDetails(id) {
                try {
                    const response = await axios.get(`${API_URL}/${id}`);
                    const t = response.data;

                    // Populate Fields
                    document.getElementById('testName').value = t.testName || '';
                    document.getElementById('category').value = t.category || '';
                    document.getElementById('patientId').value = t.patientId || '';
                    document.getElementById('doctorId').value = t.doctorId || '';
                    document.getElementById('price').value = t.price || '';
                    document.getElementById('resultStatus').value = t.resultStatus || 'Pending';
                    document.getElementById('description').value = t.description || '';
                    document.getElementById('history').value = t.history || '';

                } catch (error) {
                    console.error('Error loading test:', error);
                    alert('Error loading test details.');
                }
            }

            async function handleFormSubmit(e) {
                e.preventDefault();
                
                const id = document.getElementById('id').value;
                const formData = {
                    testName: document.getElementById('testName').value,
                    category: document.getElementById('category').value,
                    patientId: document.getElementById('patientId').value,
                    doctorId: document.getElementById('doctorId').value,
                    price: parseFloat(document.getElementById('price').value),
                    resultStatus: document.getElementById('resultStatus').value,
                    description: document.getElementById('description').value,
                    history: document.getElementById('history').value
                };

                try {
                    if (id) {
                        // UPDATE
                        await axios.put(`${API_URL}/${id}`, formData);
                        alert('Test updated successfully!');
                    } else {
                        // CREATE
                        await axios.post(API_URL, formData);
                        alert('Test created successfully!');
                    }
                    // Redirect back to list
                    window.location.href = '/admin/tests';
                } catch (error) {
                    console.error('Error saving:', error);
                    alert('Error saving test. Please check console.');
                }
            }
        </script>
    </th:block>
</body>
</html>